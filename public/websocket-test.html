<!DOCTYPE html>
<html>
<head>
    <title>Hand Teleop WebSocket Test</title>
</head>
<body>
    <h1>Hand Teleop WebSocket Test</h1>
    <video id="video" width="640" height="480" autoplay></video><br>
    <canvas id="canvas" width="640" height="480" style="border: 1px solid #ccc;"></canvas><br>
    <button onclick="startTest()">Start Test</button>
    <button onclick="stopTest()">Stop Test</button>
    <div id="log" style="white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 10px; height: 200px; overflow-y: scroll;"></div>

    <script>
        let ws = null;
        let video = null;
        let canvas = null;
        let ctx = null;
        let interval = null;
        let frameQueue = 0;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        async function startTest() {
            log('üî¨ Starting WebSocket test...');
            
            // Get video
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                log('‚úÖ Camera access granted');
            } catch (error) {
                log('‚ùå Camera access failed: ' + error.message);
                return;
            }

            // Connect WebSocket
            ws = new WebSocket('wss://hand-teleop-api.onrender.com/api/tracking/live');
            
            ws.onopen = () => {
                log('‚úÖ WebSocket connected');
                ws.send(JSON.stringify({ type: 'ping' }));
                
                // Start sending frames
                interval = setInterval(sendFrame, 200); // 5 FPS for testing
            };
            
            ws.onmessage = (event) => {
                try {
                    const response = JSON.parse(event.data);
                    if (response.type === 'pong') {
                        log('üèì Pong received');
                    } else if (response.type === 'tracking_result') {
                        frameQueue = Math.max(0, frameQueue - 1);
                        log(`üì® Tracking result: hand=${response.data.hand_detected}, queue=${frameQueue}, processing=${response.data.processing_time_ms?.toFixed(1)}ms`);
                    } else {
                        log('üìã Unknown response type: ' + response.type);
                    }
                } catch (error) {
                    log('‚ùå Error parsing response: ' + error.message);
                }
            };
            
            ws.onerror = (error) => {
                log('‚ùå WebSocket error: ' + error.message);
            };
            
            ws.onclose = (event) => {
                log(`üîå WebSocket closed: ${event.code} - ${event.reason}`);
            };
        }

        function sendFrame() {
            if (!ws || ws.readyState !== WebSocket.OPEN || !video || !ctx) {
                return;
            }
            
            if (frameQueue >= 3) {
                log('‚ö†Ô∏è Skipping frame - queue full');
                return;
            }
            
            try {
                ctx.drawImage(video, 0, 0, 640, 480);
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                const message = {
                    type: 'image',
                    data: imageData,
                    tracking_mode: 'mediapipe',
                    timestamp: new Date().toISOString()
                };
                
                ws.send(JSON.stringify(message));
                frameQueue++;
                
                if (Math.random() < 0.2) { // 20% logging
                    log(`üì§ Frame sent: ${Math.round(imageData.length / 1024)}KB, queue=${frameQueue}`);
                }
            } catch (error) {
                log('‚ùå Error sending frame: ' + error.message);
            }
        }

        function stopTest() {
            log('‚èπÔ∏è Stopping test...');
            
            if (interval) {
                clearInterval(interval);
                interval = null;
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            frameQueue = 0;
            log('‚úÖ Test stopped');
        }
    </script>
</body>
</html>
