import{a as P,b as Q,c as B}from"/build/_shared/chunk-ZVN75CDP.js";import{B as A,H as T,b as $,c as H,m as y,n as G,s as J,t as I,v as Y,w as X}from"/build/_shared/chunk-RSBDZNQN.js";import{c as q,e as V,f as K}from"/build/_shared/chunk-2QYNQQLQ.js";import{c as R,d as ge,e as W}from"/build/_shared/chunk-MFPRU5OA.js";var n=R(ge(),1);var e=R(W(),1),f=[{id:"structured-text",icon:y,name:"Structured Text",shortName:"ST",description:"IEC 61131-3 Structured Text programming language"},{id:"function-block",icon:G,name:"Function Block Diagram",shortName:"FBD",description:"Graphical programming with function blocks"},{id:"sequential-chart",icon:J,name:"Sequential Function Chart",shortName:"SFC",description:"Sequential control flow programming"},{id:"signal-mapping",icon:Y,name:"Signal Mapping",shortName:"MAP",description:"Input/output signal assignments"},{id:"digital-twin",icon:H,name:"Digital Twin",shortName:"DT",description:"3D visualization and simulation"}];function Z(){let{sessionId:ee}=q(),[te]=V(),w=te.get("prompt"),[p,m]=(0,n.useState)([]),[c,N]=(0,n.useState)(""),[v,h]=(0,n.useState)(!1),[s,u]=(0,n.useState)([]),[i,S]=(0,n.useState)(null),[d,_]=(0,n.useState)(()=>typeof window<"u"&&window.innerWidth<1024?"chat":"structured-text"),[U,ae]=(0,n.useState)(!1),[x,g]=(0,n.useState)(null),[pe,b]=(0,n.useState)(!1),[ne,oe]=(0,n.useState)(25),E=(0,n.useRef)(null),C=(0,n.useRef)(!1),L=(0,n.useRef)(!1),j=(0,n.useRef)(null),[se,re]=(0,n.useState)(!1),ie=()=>{E.current?.scrollIntoView({behavior:"smooth"})};(0,n.useEffect)(()=>{if(typeof window<"u"){let t=localStorage.getItem("plc_copilot_uploaded_files");if(t)try{let a=JSON.parse(t);u(a),console.log("Loaded files from localStorage:",a)}catch(a){console.error("Failed to parse uploaded files from localStorage:",a)}}},[]),(0,n.useEffect)(()=>{ie()},[p]),(0,n.useEffect)(()=>{if(w&&!U&&p.length===0){ae(!0);let t={id:Date.now().toString(),content:w,role:"user",timestamp:new Date,hasFiles:s.length>0};console.log("Creating initial message with hasFiles:",s.length>0,"uploadedFiles:",s),m([t]),le(t)}},[w,U,p.length,s]);let le=async t=>{if(C.current){console.log("API call already in progress, skipping");return}C.current=!0,h(!0),b(!0),g(null);try{let a=await P.chat({user_prompt:`Context: You are PLC Copilot, an expert assistant for industrial automation and PLC programming. User request: ${t.content}`,model:"gpt-4o-mini",temperature:.7,max_completion_tokens:1024}),o={id:(Date.now()+1).toString(),content:a.content,role:"assistant",timestamp:new Date};m(r=>[...r,o])}catch(a){console.error("API call failed:",a);let o=a instanceof Error?a.message:"Unknown error occurred";g(o);let r={id:(Date.now()+1).toString(),content:"I'm having trouble connecting to the backend right now. Please check your connection or try again later. In the meantime, I can help you with general PLC programming guidance.",role:"assistant",timestamp:new Date};m(l=>[...l,r])}finally{h(!1),b(!1),C.current=!1}},F=async t=>{if(t.preventDefault(),!c.trim()||v)return;let a={id:Date.now().toString(),content:c.trim(),role:"user",timestamp:new Date,hasFiles:s.length>0};m(o=>[...o,a]),N(""),h(!0),b(!0),g(null);try{let o=await P.chat({user_prompt:`Context: You are PLC Copilot, an expert assistant for industrial automation and PLC programming. User request: ${a.content}`,model:"gpt-4o-mini",temperature:.7,max_completion_tokens:1024}),r={id:(Date.now()+1).toString(),content:o.content,role:"assistant",timestamp:new Date};m(l=>[...l,r])}catch(o){console.error("API call failed:",o);let r=o instanceof Error?o.message:"Unknown error occurred";g(r);let l={id:(Date.now()+1).toString(),content:"I'm having trouble connecting to the backend right now. Please check your connection or try again later. In the meantime, I can help you with general PLC programming guidance.",role:"assistant",timestamp:new Date};m(k=>[...k,l])}finally{h(!1),b(!1)}},de=t=>{t.key==="Enter"&&!t.shiftKey&&window.innerWidth>=1024&&(t.preventDefault(),F(t))},ce=t=>{},me=t=>{t.preventDefault(),L.current=!0,document.addEventListener("mousemove",M),document.addEventListener("mouseup",D)},M=t=>{if(!L.current)return;let a=window.innerWidth,o=t.clientX/a*100,r=Math.min(Math.max(o,20),60);oe(r)},D=()=>{L.current=!1,document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",D)},ve=t=>{let a=t.target.files;a&&(Array.from(a).forEach(async o=>{let r=Date.now().toString()+Math.random().toString(36).substr(2,9),l=null;try{l=await o.text()}catch{l=null}let k={id:r,name:o.name,size:o.size,type:o.type,content:l};u(z=>[...z,k]),S(r)}),j.current&&(j.current.value=""))},O=t=>{u(a=>a.filter(o=>o.id!==t)),S(a=>a===t?null:a)};(0,n.useEffect)(()=>{try{let t=localStorage.getItem("plc_copilot_uploaded_files");t&&u(JSON.parse(t))}catch{}},[]),(0,n.useEffect)(()=>{try{localStorage.setItem("plc_copilot_uploaded_files",JSON.stringify(s))}catch{}},[s]),(0,n.useEffect)(()=>()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",D)},[]);let ue=()=>{switch(d){case"structured-text":return(0,e.jsx)("div",{className:"h-full p-6 flex flex-col min-h-0",children:(0,e.jsx)("div",{className:"font-mono text-sm bg-gray-900 rounded-lg flex flex-col min-h-0 flex-1",children:(0,e.jsx)("div",{className:"flex-1 overflow-y-auto p-6",children:(0,e.jsx)("pre",{className:"text-gray-200 whitespace-pre-wrap",children:`// Conveyor Belt Control System
// Generated by PLC Copilot

PROGRAM ConveyorControl
VAR
    bStart          : BOOL := FALSE;      // Start button
    bStop           : BOOL := FALSE;      // Stop button  
    bEmergencyStop  : BOOL := FALSE;      // E-stop
    bMotorRunning   : BOOL := FALSE;      // Motor status
    bSafetyOK       : BOOL := TRUE;       // Safety check
    tMotorTimer     : TON;                // Motor timer
    
    // Inputs
    bStartButton    : BOOL;
    bStopButton     : BOOL;
    bEStop          : BOOL;
    bSafetyGate     : BOOL;
    
    // Outputs
    qMotorContactor : BOOL;
    qStatusLight    : BOOL;
END_VAR

// Main control logic
IF bEStop OR NOT bSafetyGate THEN
    bSafetyOK := FALSE;
    qMotorContactor := FALSE;
    bMotorRunning := FALSE;
ELSE
    bSafetyOK := TRUE;
END_IF;

// Start/Stop logic
IF bStartButton AND bSafetyOK AND NOT bMotorRunning THEN
    bStart := TRUE;
ELSIF bStopButton OR NOT bSafetyOK THEN
    bStart := FALSE;
END_IF;

// Motor control
IF bStart AND bSafetyOK THEN
    qMotorContactor := TRUE;
    bMotorRunning := TRUE;
ELSE
    qMotorContactor := FALSE;
    bMotorRunning := FALSE;
END_IF;

// Status indication
qStatusLight := bMotorRunning;

END_PROGRAM`})})})});default:return(0,e.jsx)("div",{className:"flex items-center justify-center h-full text-gray-400",children:(0,e.jsxs)("div",{className:"text-center",children:[(0,e.jsx)("div",{className:"w-16 h-16 bg-orange-500/10 rounded-full flex items-center justify-center mx-auto mb-4",children:f.find(t=>t.id===d)?.icon&&(0,n.createElement)(f.find(t=>t.id===d).icon,{className:"w-8 h-8 text-orange-500"})}),(0,e.jsx)("h3",{className:"text-lg font-medium text-white mb-2",children:f.find(t=>t.id===d)?.name}),(0,e.jsx)("p",{className:"text-sm",children:f.find(t=>t.id===d)?.description})]})})}};return(0,e.jsxs)("div",{className:"h-screen bg-gray-950 text-white flex flex-col overflow-hidden",children:[(0,e.jsx)("header",{className:"border-b border-gray-800 px-6 py-4 flex-shrink-0 z-10",children:(0,e.jsx)("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:(0,e.jsxs)("div",{className:"flex items-center gap-3",children:[(0,e.jsx)(K,{to:"/projects/plc-copilot",className:"p-2 hover:bg-gray-800 rounded-lg transition-colors",children:(0,e.jsx)($,{className:"w-5 h-5"})}),(0,e.jsxs)("div",{className:"flex items-center gap-3",children:[(0,e.jsx)("div",{className:"w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center",children:(0,e.jsx)(I,{className:"w-5 h-5 text-white"})}),(0,e.jsxs)("div",{children:[(0,e.jsx)("h1",{className:"text-xl font-semibold",children:"PLC Copilot"}),(0,e.jsxs)("div",{className:"flex items-center gap-3",children:[(0,e.jsxs)("p",{className:"text-sm text-gray-400",children:["Session ",ee||"new"]}),(0,e.jsx)(Q,{}),(0,e.jsxs)("div",{className:"relative",children:[(0,e.jsxs)("button",{onClick:()=>re(t=>!t),className:"ml-2 flex items-center gap-1 bg-gray-800 border border-gray-700 rounded-full px-2 py-1 text-xs text-gray-300",title:"Uploaded files",children:[(0,e.jsx)(X,{className:"w-3 h-3"}),(0,e.jsx)("span",{children:s.length})]}),se&&s.length>0&&(0,e.jsx)("div",{className:"absolute right-0 mt-2 w-48 bg-gray-900 border border-gray-800 rounded-lg p-2 shadow-lg z-50",children:s.map(t=>(0,e.jsxs)("div",{className:"flex items-center justify-between text-sm text-white py-1",children:[(0,e.jsx)("span",{className:"truncate max-w-[220px]",children:t.name}),(0,e.jsx)("button",{onClick:()=>O(t.id),className:"text-red-400 hover:text-red-500 ml-2",children:(0,e.jsx)(T,{className:"w-3 h-3"})})]},t.id))})]})]})]})]})]})})}),(0,e.jsxs)("div",{className:"flex-1 flex lg:flex-row flex-col min-h-0 overflow-hidden",children:[(0,e.jsxs)("div",{className:"hidden lg:flex flex-col bg-gray-900 border-r border-gray-800 min-h-0 relative",style:{width:`${ne}%`},children:[(0,e.jsxs)("div",{className:"flex-1 overflow-y-auto px-6 py-6 min-h-0 relative",children:[s.length>0&&(0,e.jsx)("div",{className:"absolute right-6 top-6 z-20",children:(0,e.jsxs)("div",{className:"bg-neutral-50 text-gray-900 rounded-lg px-3 py-2 flex items-center gap-3 shadow-sm border border-gray-200",style:{minWidth:180},children:[(0,e.jsx)("div",{className:"w-8 h-8 bg-red-500 rounded-md flex items-center justify-center text-white text-xs font-semibold",children:"PDF"}),(0,e.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,e.jsx)("div",{className:"text-sm font-medium truncate",children:s[0].name}),(0,e.jsx)("div",{className:"text-xs text-gray-500",children:s[0].type?.split("/").pop()?.toUpperCase()||"FILE"})]})]})}),(0,e.jsxs)("div",{className:"space-y-4 max-w-none",children:[p.map((t,a)=>(0,e.jsxs)("div",{children:[t.role==="user"&&(0,e.jsxs)("div",{className:"text-xs text-gray-500 mb-1",children:["Debug: hasFiles=",String(t.hasFiles),", uploadedFiles=",s?.length||0]}),t.role==="user"&&t.hasFiles&&(0,e.jsx)("div",{className:"flex justify-end mb-1",children:(0,e.jsx)("div",{className:"bg-red-500 text-white px-3 py-1 rounded text-sm font-bold",children:"\u{1F4CE} FILE ATTACHED"})}),(0,e.jsx)("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:(0,e.jsxs)("div",{className:`max-w-[85%] rounded-lg px-4 py-3 ${t.role==="user"?"bg-orange-500 text-white":"bg-gray-800 text-gray-100"}`,children:[(0,e.jsx)("p",{className:"whitespace-pre-wrap",children:t.content}),(0,e.jsx)("time",{className:"text-xs opacity-70 mt-1 block",children:t.timestamp.toLocaleTimeString()})]})})]},t.id)),v&&(0,e.jsx)("div",{className:"flex justify-start",children:(0,e.jsx)("div",{className:"bg-gray-800 rounded-lg px-3 py-2",children:(0,e.jsxs)("div",{className:"flex items-center gap-2",children:[(0,e.jsx)("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-bounce"}),(0,e.jsx)("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,e.jsx)("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})})]}),x&&(0,e.jsx)(B,{error:x,onRetry:()=>g(null),className:"mt-4"}),(0,e.jsx)("div",{ref:E})]}),(0,e.jsxs)("div",{className:"border-t border-gray-800 p-6 flex-shrink-0",children:[(0,e.jsxs)("form",{onSubmit:F,children:[s.length>0&&(0,e.jsx)("div",{className:"mb-3 flex flex-wrap gap-2",children:s.map(t=>(0,e.jsxs)("div",{className:"flex items-center gap-3 bg-gray-900 border border-gray-800 rounded-full px-3 py-2 text-sm",children:[(0,e.jsx)(y,{className:"w-4 h-4 text-gray-300"}),(0,e.jsx)("span",{className:"max-w-[220px] truncate text-white",children:t.name}),(0,e.jsx)("span",{className:"text-xs text-gray-400",children:t.type?.split("/").pop()?.toUpperCase()||""}),(0,e.jsx)("button",{onClick:()=>O(t.id),className:"text-gray-400 hover:text-red-400 ml-2",children:(0,e.jsx)(T,{className:"w-3 h-3"})})]},t.id))}),(0,e.jsxs)("div",{className:"relative",children:[(0,e.jsx)("textarea",{value:c,onChange:t=>N(t.target.value),onKeyDown:de,placeholder:"Describe your automation requirements...",className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 pr-12 resize-none focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent text-white placeholder-gray-400",rows:3}),(0,e.jsx)("button",{type:"submit",disabled:!c.trim()||v,className:"absolute right-2 bottom-2 p-1.5 bg-orange-500 text-white rounded-md hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,e.jsx)(A,{className:"w-3 h-3"})})]})]}),(0,e.jsx)("p",{className:"text-xs text-gray-500 mt-2 text-center",children:"Press Enter to send, Shift+Enter for new line"})]})]}),(0,e.jsx)("div",{className:"hidden lg:block w-2 bg-gray-700 hover:bg-orange-500 cursor-col-resize transition-colors relative group",onMouseDown:me,title:"Drag to resize",children:(0,e.jsx)("div",{className:"absolute inset-y-0 left-1/2 transform -translate-x-1/2 w-0.5 bg-gray-600 group-hover:bg-orange-400"})}),(0,e.jsxs)("div",{className:"flex-1 flex flex-col bg-gray-950 min-h-0",children:[(0,e.jsx)("div",{className:"border-b border-gray-800 px-6 py-3 flex-shrink-0 sticky top-0 bg-gray-950 z-20",children:(0,e.jsxs)("div",{className:"flex gap-1 overflow-x-auto",children:[(0,e.jsxs)("button",{onClick:()=>_("chat"),className:`lg:hidden group relative p-2 rounded-lg transition-colors flex-shrink-0 ${d==="chat"?"bg-orange-500 text-white":"hover:bg-gray-800 text-gray-400"}`,title:"Chat",children:[(0,e.jsx)(I,{className:"w-5 h-5"}),(0,e.jsx)("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-30",children:"Chat"})]}),f.map(t=>(0,e.jsxs)("button",{onClick:()=>_(t.id),className:`group relative p-2 rounded-lg transition-colors flex-shrink-0 ${d===t.id?"bg-orange-500 text-white":"hover:bg-gray-800 text-gray-400"}`,title:t.name,children:[(0,e.jsx)(t.icon,{className:"w-5 h-5"}),(0,e.jsx)("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-30",children:t.name})]},t.id))]})}),(0,e.jsx)("div",{className:"flex-1 overflow-hidden min-h-0",children:d==="chat"?(0,e.jsxs)("div",{className:"h-full flex flex-col lg:hidden",children:[(0,e.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-6 min-h-0 relative",children:[s.length>0&&(0,e.jsx)("div",{className:"absolute right-4 top-4 z-20",children:(0,e.jsxs)("div",{className:"bg-neutral-50 text-gray-900 rounded-lg px-3 py-2 flex items-center gap-3 shadow-sm border border-gray-200",style:{minWidth:160},children:[(0,e.jsx)("div",{className:"w-7 h-7 bg-red-500 rounded-md flex items-center justify-center text-white text-xs font-semibold",children:"PDF"}),(0,e.jsx)("div",{className:"flex-1 min-w-0",children:(0,e.jsx)("div",{className:"text-xs font-medium truncate",children:s[0].name})})]})}),(0,e.jsxs)("div",{className:"space-y-4 max-w-none pb-4",children:[p.map((t,a)=>(0,e.jsxs)("div",{children:[t.role==="user"&&(0,e.jsxs)("div",{className:"text-xs text-gray-500 mb-1",children:["Debug: hasFiles=",String(t.hasFiles),", uploadedFiles=",s?.length||0]}),t.role==="user"&&t.hasFiles&&(0,e.jsx)("div",{className:"flex justify-end mb-1",children:(0,e.jsx)("div",{className:"bg-red-500 text-white px-2 py-1 rounded text-xs font-bold",children:"\u{1F4CE} FILE ATTACHED"})}),(0,e.jsx)("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:(0,e.jsxs)("div",{className:`max-w-[85%] rounded-lg px-4 py-3 ${t.role==="user"?"bg-orange-500 text-white":"bg-gray-800 text-gray-100"}`,children:[(0,e.jsx)("p",{className:"whitespace-pre-wrap",children:t.content}),(0,e.jsx)("time",{className:"text-xs opacity-70 mt-1 block",children:t.timestamp.toLocaleTimeString()})]})})]},t.id)),v&&(0,e.jsx)("div",{className:"flex justify-start",children:(0,e.jsx)("div",{className:"bg-gray-800 rounded-lg px-3 py-2",children:(0,e.jsxs)("div",{className:"flex items-center gap-2",children:[(0,e.jsx)("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-bounce"}),(0,e.jsx)("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,e.jsx)("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})})]}),x&&(0,e.jsx)(B,{error:x,onRetry:()=>g(null),className:"mx-4 mb-2"}),(0,e.jsx)("div",{ref:E})]}),(0,e.jsx)("div",{className:"border-t border-gray-800 p-4 flex-shrink-0 bg-gray-950",children:(0,e.jsxs)("form",{onSubmit:F,children:[i&&(0,e.jsxs)("div",{className:"mb-2 flex items-center justify-between bg-gray-900 border border-gray-800 rounded-t-lg px-3 py-2",children:[(0,e.jsxs)("div",{className:"flex items-center gap-3",children:[(0,e.jsx)(y,{className:"w-4 h-4 text-gray-300"}),(0,e.jsx)("input",{className:"bg-transparent text-sm text-white placeholder-gray-500 focus:outline-none",value:s.find(t=>t.id===i)?.name||"",onChange:t=>{let a=t.target.value;u(o=>o.map(r=>r.id===i?{...r,name:a}:r))}})]}),(0,e.jsxs)("div",{className:"flex items-center gap-2",children:[(0,e.jsx)("button",{type:"button",onClick:()=>S(null),className:"text-gray-400 hover:text-white text-sm",children:"Cancel"}),(0,e.jsx)("button",{type:"button",onClick:()=>O(i),className:"text-red-400 hover:text-red-500 text-sm",title:"Remove file",children:"Remove"})]})]}),(0,e.jsxs)("div",{className:"relative",children:[(0,e.jsx)("textarea",{value:i?s.find(t=>t.id===i)?.content??c:c,onChange:t=>{let a=t.target.value;i?u(o=>o.map(r=>r.id===i?{...r,content:a}:r)):N(a)},onKeyDown:ce,placeholder:i?"Edit file content...":"Your thoughts...",className:`w-full bg-gray-800 border border-gray-700 ${i?"rounded-b-lg rounded-t-none":"rounded-lg"} px-4 py-3 pr-12 resize-none focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent text-white placeholder-gray-400`,rows:i?8:2}),(0,e.jsx)("button",{type:"submit",disabled:!(i?(s.find(t=>t.id===i)?.content??"").trim():c.trim())||v,className:"absolute right-2 bottom-2 p-1.5 bg-orange-500 text-white rounded-md hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,e.jsx)(A,{className:"w-3 h-3"})})]})]})})]}):(0,e.jsx)("div",{className:"flex-1 min-h-0",children:ue()})})]})]})]})}export{Z as default};
